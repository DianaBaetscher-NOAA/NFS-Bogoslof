---
title: "fecal-mifish-taxonomy-analysis"
author: "dsb"
date: "2024-09-25"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Using input data from the Rmd `fecal-mifish-dada2.Rmd` and blastn/taxonkit output from sedna and the eDNA VM.

Plus, output from salmon/gadid custom database from Kim:

```{sh, eval=F}
# gadids
blastn -query NFSfecal_MiFish_ASV_seqtab_nochim.csv -db ../custom_dbs/gadidae_db -out ../blastn/fecal_gadidae_results.txt -perc_identity 96 -qcov_hsp_perc 100 -num_threads 10 -outfmt '6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore sscinames staxids'

# salmon
blastn -query NFSfecal_MiFish_ASV_seqtab_nochim.csv -db ../custom_dbs/oncorhynchus_db -out ../blastn/fecal_salmon_results.txt -perc_identity 96 -qcov_hsp_perc 100 -num_threads 10 -outfmt '6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore sscinames staxids'
```



```{r load-libraries}
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(tidyverse)

# for adding distribution data
library(rfishbase)

```

```{r load-output-from-taxonkit}
taxonomy <-read_tsv("../data/NFSfecal_mifish_shorttaxlineage.txt", col_names = F)
salmon <- read_tsv("../data/fecal_salmon_results.txt", col_names = F) %>%
  mutate(genus = "Oncorhynchus", family = "Salmonidae") %>%
  select(X1:X3, genus, family)
gadids <- read_tsv("../data/fecal_gadidae_results.txt", col_names = F) %>%
  separate(X2, into = c("genus", "spp"), remove = F) %>%
  mutate(family = "Gadidae") %>%
  select(X1:X3, genus, family)
```


```{r load-output-from-taxonkit}
# the ASV numbers should be consistent across the three blastn outputs.
# so I should be able to remove the ASVs that occur in the salmon and gadid dbs from the full taxonomy df
salmon_asv <- salmon %>%
  select(X1) %>%
  unique() 

gadid_asv <- gadids %>%
  select(X1) %>%
  unique()

# summarize data from custom database
salmon_gadid_spp <- bind_rows(salmon, gadids) %>%
  rename(ASV = X1, species = X2, perc_id = X3) %>%
  mutate(species = str_replace(species, "_", " ")) # species names have a space in the blast output
  

# full blastn output
taxonomy_wo_salmonGadids <- taxonomy %>%
  anti_join(., salmon_asv) %>%
  anti_join(., gadid_asv)

# can I just join everything initially, then run rfishbase for distribution
# and then perform the taxonomic level assignment on the range-filtered data

# first clean up the header
taxon_df <- taxonomy_wo_salmonGadids %>%
  select(-X2, -(X4:X16)) %>%  #remove unnecessary columns
  group_by(X1, X17) %>% # group by the sequence key and the full taxonomy to reduce duplicate entries
  unique() %>% # doing that reduced the number of entries significantly
  rename(ASV=X1, perc_id=X3, taxonomy=X17) %>% #rename headers
  filter(!str_detect(taxonomy, "environmental")) %>% # filter out any environmental samples
  filter(!str_detect(taxonomy, "synthetic")) %>% # filter out any synthetic "samples"
  filter(!str_detect(taxonomy, "bacterium")) %>%
  filter(!str_detect(taxonomy, "bacteria")) %>%
  filter(!str_detect(taxonomy, "cultured")) %>% # formatting the taxonomy variables
  filter(str_detect(taxonomy, ";")) %>%
  separate(taxonomy, into=c("kingdom", "phylum", "class", "order", "family", "genus", "species"), sep = ";") %>% 
  filter(!str_detect(species, " x ")) %>% # remove hybrids
  # remove other stuff that isn't on-target or out of range
  filter(!species %in% c("Homo sapiens", "Canis lupus", "Oncorhynchus kawamurae", "Ammodytes japonicus", "Sebastes baramenuke", "Sebastes cheni", "Sebastes inermis", "uncultured bacterium", "Hexagrammos otakii")) %>% # remove species outside of their range
  filter(!str_detect(species, " sp. ")) %>%
  filter(!genus %in% c("Sus", "Bos", "Gorilla")) %>% # remove non-marine mammals
  filter(!order %in% c("Primates"))
 
# combine salmon, gadids, and the rest of the species 
taxa_df_for_range <- taxon_df %>%
  bind_rows(., salmon_gadid_spp)

```

# Check on the range here, prior to collapsing to taxonomic levels

### Adding distribution info from rfishbase


Kim has code to verify that species are within reasonable range/distributions. -- I'm adding that below:

now let's take a closer look at the assignments we are getting from inital blastn 

## what non-fish are here? 
```{r}
not_Actinopteri <- taxa_df_for_range %>%
  ungroup() %>%
  filter(class != "Actinopteri") %>%
  select(species, genus, family, order, class, phylum) %>%
  unique() %>%
  select(species)

not_Actinopteri
```
all of those make sense.

## now look at the fish and figure out what taxa are in/out of our range
```{r}
to_check_range <- taxa_df_for_range %>%
  ungroup() %>%
  filter(class == "Actinopteri") %>%
  select(species, genus, family, order, class, phylum) %>%
  unique()

```

## check ranges for species using rfishbase 
## also at this step, check 
```{r check-for-synonyms}
#first, validate species names using rfishbase synonyms
spp_df <- synonyms(to_check_range$species)

syn <- spp_df %>%
  filter(Status == "synonym")

# this function isn't working as intended for me...
# there are a bunch of manual mismatches in the replacement
# to_check_range2 <- to_check_range %>%
#   mutate(validated_name = ifelse(species %in% syn$synonym, syn$Species, species))

# this performs the by-row substitution for the synonyms
to_check_range2 <- to_check_range %>%
  left_join(., spp_df, by = c("species" = "synonym")) %>%
  #filter(Status == "synonym") %>%
  mutate(validated_species = ifelse(Status == "synonym", Species, species))

```


```{r apply-distribution-range-info}
# this loads a large table into memory
fishbase_spp <- fb_tbl("species")
head(fishbase_spp)

#get distribution info
spp_distribution <- faoareas(to_check_range2$validated_species) %>%
  select(Species, FAO) %>%
  unique()

#add column to designate if we will consider a species as "in range"- for this study, this will be NE Pacific and Arctic Ocean
spp_distribution_range <- spp_distribution %>%
  mutate(in_range = ifelse(is.na(FAO), NA, "no"),
         in_range = ifelse(FAO == "Pacific, Northeast", "yes", in_range))
        # in_range = ifelse(FAO == "Arctic Ocean", "yes", in_range)) # removing the arctic for this dataset.

# confirm that the species look appropriate
# add back synonyms that could be in the blastn output
syn_to_addback <- spp_distribution_range %>%
  inner_join(., syn) %>%
  filter(in_range == "yes") %>%
  select(Species, synonym, FAO, in_range) %>%
  unique() %>%
  rename(species = Species)

#keep just a list of spp names and yes/no/NA for "in range"  - this way we can keep track of what spp didn't have any reference information in fishbase to determine range
spp_in_range <- spp_distribution_range %>%
  select(Species, FAO, in_range) %>%
  filter(in_range == "yes") %>%
  unique() %>%
  rename(species = Species) 

all_taxa_in_range <- bind_rows(spp_in_range, syn_to_addback, not_Actinopteri) %>%
  select(species) %>%
  unique()
# how to deal with the synonyms?
# probably need to add them in here?
```
145 species in range.

```{r filtering-taxonomy-based-on-distribution-data}
# keep species that are within the appropriate distribution
taxa_in_range <- taxa_df_for_range %>%
  inner_join(., all_taxa_in_range)

# blastn results that are excluded based on distributions
taxa_df_for_range %>%
  anti_join(., all_taxa_in_range)

```

Now, using those data, let's go through this procedure to identify the appropriate taxonomic level for each sequence.


There are four categories:
1. sequences that match a single species unambiguously (the minority)

Sequences that match multiple species are divided in three categories:
2. top matches > 2% identity than second-ranked matches
3. top matches < 2% identity than second-ranked matches
4. Multiple top matches with the same % identity

```{r single-species-sequences}
# 1. sequences that are unambiguously a single species
single_spp_seqs <- taxa_in_range %>% 
  group_by(ASV, species) %>%
  tally() %>% # how many species per ASV?
  group_by(ASV) %>%
  select(-n) %>%
  add_tally(name = "n_taxa") %>%
  filter(n_taxa == 1)
  
single_spp_seqs %>%
  left_join(., taxa_in_range) %>%
  select(perc_id, ASV, species)
```
241 ASVs that are unique to a single species.

How many species do those ASVs represent?
```{r}
single_spp_seqs %>%
  ungroup() %>%
  select(species) %>%
  unique()
```
31 species - single ASVs to species


```{r filter-taxonomy-to-exclude-single-species-ASVs}
# remove the single-species seqs from the dataframe and then rank the hits by % identity for the remaining seqs
seq_id_diff <- taxa_in_range %>%
  anti_join(., single_spp_seqs) %>%
  group_by(ASV, species, genus, family, order, class, phylum, kingdom) %>%
    mutate(seq_percID = max(perc_id)) %>%
    group_by(ASV, species, genus, family, order, class, phylum, kingdom, seq_percID) %>%
  summarise(max(seq_percID)) %>% # take just the top hit for each taxon (for each sequence)
  select(-`max(seq_percID)`) %>%
  ungroup() %>%
  group_by(ASV) %>%
      mutate(id_rank = rank(desc(seq_percID), ties.method = "min")) %>% # rank the taxonomic hits per sequence by % id
       mutate(top_perc = max(seq_percID)) %>% # designate the highest % id for the best taxonomic hit in each sequence (in some, but not all cases, this is 100%)   
      mutate(diff = top_perc - seq_percID) %>% # calculate the difference between the % identity of the top hit and each subsequent taxonomic hit
        arrange(diff)

seq_id_diff %>%
  filter(diff > 0.5)
```
```{r investigate-salmon-asvs}
# salmon with 100% sequence matches?
seq_id_diff %>%
  filter(genus == "Oncorhynchus") %>%
  filter(seq_percID != 100) %>%
  arrange(ASV)

# salmon
seq_id_diff %>%
  filter(genus == "Oncorhynchus") %>%
  arrange(ASV, id_rank) %>%
  filter(diff < 1) # remove potential hits that are >1% different

  # group_by(ASV) %>%
  # add_tally() %>%
  # filter(n == 1) %>%
  # tally() %>%
  # left_join(., seq_id_diff) %>%
  # filter(diff < 0.5)
```
salmon: 9 ASVs with 2 species at 0.5% difference, 60 ASVs at species-level!
9 ASVs that match with 100% sequence identity.

```{r}
seq_id_diff %>%
  filter(genus == "Gadus") %>%
  filter(seq_percID == 100) %>%
  arrange(ASV)


```





Now I have the single best entry for each species for each sequence ranked with the difference between the first and second ranked entries calculated.

For sequences with multiple top hits, where the difference between ranked taxa = 0, I will end up defaulting to genus- or family-level ID (or carrying the individual species info around in some capacity). I will do the same for any sequences where the difference betweeen the first and second ranked taxa is < 0.5%.


Figure out which differences are > 0.5% and eliminate those first?
```{r remove-low-perc-identity-matches}
# filter out any taxa that are >1% less matching identity than the top taxonomic hit for a given sequence
to_remove_low_perc_hits <- seq_id_diff %>%
  ungroup() %>%
  group_by(ASV) %>%
  filter(diff > 0.5) # using a 0.5% threshold, there are 1719 rows in this df

keepers <- seq_id_diff %>%
  anti_join(to_remove_low_perc_hits)

```

```{r all-higher-level-taxonomic-assignments}
# this data frame includes only those taxonomic hits that should be considered.
# so now I need to determine whether they should be assigned to genus, family, order, etc. 

# Single-species matches now that we've filtered based on percent identity
singleton_df <- keepers %>%
  select(ASV) %>%
  tally() %>%
  filter(n == 1) %>% # these are the seqs that now have only a single match
  left_join(keepers) %>%
  select(-n) %>%
  bind_rows(single_spp_seqs) %>% # combine the single spp data
  mutate(taxonomic_level = "species") %>%
  mutate(taxon = species)

## Genus-level matches
# remove the singletons from the bigger df 
single_genus <- keepers %>%
  anti_join(., singleton_df, by = "ASV") %>% # at best, these should be genus-level matches
  group_by(ASV, genus) %>%
  tally() %>%
  ungroup() %>%
  group_by(ASV) %>%
  tally() %>%
  filter(n == 1) %>% # seqs that match a single genus
  select(-n) %>%
  left_join(., keepers) %>%
  mutate(taxonomic_level = "genus") %>%
  mutate(taxon = genus)
  

## Family-level matches
single_family <- keepers %>%
  anti_join(., singleton_df, by = "ASV") %>%
  anti_join(., single_genus) %>%
  group_by(ASV, family) %>%
  tally() %>%
  ungroup() %>%
  group_by(ASV) %>%
  tally() %>%
  filter(n == 1) %>% # seqs that match a single family
  select(-n) %>%
  left_join(., keepers) %>%
  mutate(taxonomic_level = "family") %>%
  mutate(taxon = family)


## Order-level matches
single_order <- keepers %>%
 anti_join(., singleton_df, by = "ASV") %>%
  anti_join(., single_genus) %>%
  anti_join(., single_family) %>%
  group_by(ASV, order) %>%
  tally() %>%
  ungroup() %>%
  group_by(ASV) %>%
  tally() %>%
  filter(n == 1) %>% # seqs that match a single order
  select(-n) %>%
  left_join(., keepers) %>%
  mutate(taxonomic_level = "order") %>%
  mutate(taxon = order)


## Class-level matches
single_class <- keepers %>%
  anti_join(., singleton_df, by = "ASV") %>%
  anti_join(., single_genus) %>%
  anti_join(., single_family) %>%
  anti_join(., single_order) %>%
  group_by(ASV, class) %>%
  tally() %>%
  ungroup() %>%
  group_by(ASV) %>%
  tally() %>% 
  filter(n == 1) %>% # seqs that match a single class
  select(-n) %>%
  left_join(., keepers) %>%
  mutate(taxonomic_level = "class") %>%
  mutate(taxon = class)

# no higher level taxonomy was relevant in this dataset.
```


```{r combine-taxonomic-level-df}
# combine those sub-dataframes
tax_df_w_gadidSalmon <- bind_rows(singleton_df, single_genus, single_family, single_order, single_class) %>%
  select(-id_rank, -top_perc, -diff, -seq_percID, -n_taxa)
  
tax_df_w_gadidSalmon %>%
  filter(ASV == "ASV115")
```




```{r old-code-for-analyzing-salmon-gadids-separately}
# summarize data from custom database
# salmon_gadid_spp <- bind_rows(salmon, gadids) %>%
#   rename(ASV = X1, species = X2, perc_id = X3) %>%
#   select(1:3)
#   
# # are there any single-species sequences?
# # 1. sequences that are unambiguously a single species
# salmon_gadid_spp %>% 
#   group_by(ASV, species) %>%
#   tally() %>% # how many species per ASV?
#   group_by(ASV) %>%
#   select(-n) %>%
#   add_tally(name = "n_taxa") %>%
#   filter(n_taxa == 1)

# nope, not shocking, but no single-species sequences
```


```{r}
# identify the highest percent ID per ASV and then evaluate if it's >0.5% from the next species
# sal_gad_df <- salmon_gadid_spp %>%
#   group_by(ASV, species) %>%
#    mutate(seq_percID = max(perc_id)) %>%
#     group_by(ASV, species, seq_percID) %>%
#   summarise(max(seq_percID)) %>% # take just the top hit for each taxon (for each sequence)
#   select(-`max(seq_percID)`) %>%
#   ungroup() %>%
#   group_by(ASV) %>%
#       mutate(id_rank = rank(desc(seq_percID), ties.method = "min")) %>% # rank the taxonomic hits per sequence by % id
#        mutate(top_perc = max(seq_percID)) %>% # designate the highest % id for the best taxonomic hit in each sequence (in some, but not all cases, this is 100%)   
#       mutate(diff = top_perc - seq_percID) %>% # calculate the difference between the % identity of the top hit and each subsequent taxonomic hit
#         arrange(diff)
# 
# 
# # Now identify which ASVs have > 0.5% between species
# sal_gad_top <- sal_gad_df %>%
#   filter(diff < 0.5) %>%
#   separate(species, into = c("genus", "spp"), remove = F) %>%
#   mutate(family = ifelse(genus %in% c("Gadus","Boreogadus", "Microgadus", "Eleginus"), "Gadidae", "Salmonidae"))
# 
# # now are there single-species asvs?
# ss_asvs_salgad <- sal_gad_top %>%
#   group_by(ASV) %>%
#   tally() %>%
#   filter(n == 1) %>%
#   left_join(., sal_gad_top) %>%
#   select(-n, -id_rank, -top_perc, -diff) %>%
#   mutate(taxonomic_level = "species") %>%
#   mutate(taxon = species)
#   
# # 77 species-specific sequences
# 
# genus_salgad <- sal_gad_top %>%
#   anti_join(., ss_asvs_salgad) %>%
#   group_by(ASV, genus) %>%
#   tally() %>%
#   ungroup() %>%
#   group_by(ASV) %>%
#   tally() %>%
#   filter(n == 1) %>% # seqs that match a single genus
#   select(-n) %>%
#   left_join(., sal_gad_top) %>%
#   mutate(taxonomic_level = "genus") %>%
#   mutate(taxon = genus)
# 
# genus_salgad %>%
#   select(ASV) %>%
#   unique()
# 
# # 53 genus-specific sequences
# 
# # family-level
# family_salgad <- sal_gad_top %>%
#   anti_join(., ss_asvs_salgad) %>%
#   anti_join(., genus_salgad) %>%
#   group_by(ASV, family) %>%
#   tally() %>%
#   ungroup() %>%
#   group_by(ASV) %>%
#   tally() %>%
#   filter(n == 1) %>% # seqs that match a single genus
#   select(-n) %>%
#   left_join(., sal_gad_top) %>%
#   mutate(taxonomic_level = "family") %>%
#   mutate(taxon = family)
# 
# # 2 ASVs that match family-level for Gadidae
# 
# 
# # merge those dataframes
# sal_gadid_filtered_tax <- bind_rows(family_salgad, genus_salgad, ss_asvs_salgad) %>%
#   select(1:3, 9:11)

```

```{r combine-and-output-taxonomy}
# recombine the full data set now that the appropriate level of taxonomy has been determined
#sorted_tax_df <- bind_rows(sal_gadid_filtered_tax, tax_df_wo_gadidSalmon)

# sorted_tax_df %>%
#   select(ASV, taxon, taxonomic_level) %>%
#   unique() %>%
#   write_csv("csv_outputs/fecal_taxonomy_extra_gadidSalmon.csv")

```




Create output taxonomy data frames
```{r output-taxonomy}
uncollapsed_taxonomy <- tax_df_w_gadidSalmon %>%
  #select(-top_perc, -id_rank) %>%
  unique()


# quick look at the taxonomy before collapsing it:
uncollapsed_taxonomy %>%
  write_csv("csv_outputs/inrange_uncollapsed_taxonomy_fecal_mifish.csv")

# and then collapse that down to just a single taxon per ASV
collapsed_taxonomy <- uncollapsed_taxonomy %>%
  select(ASV, taxon, taxonomic_level) %>%
  unique()

# then remove those high level taxonomic assignments that aren't informative
collapsed_taxonomy %>%
  #filter(!taxonomic_level %in% c("class", "order")) %>%
  select(-ASV) %>%
  unique()


collapsed_taxonomy %>%
  select(-ASV) %>%
  unique() %>%
  group_by(taxonomic_level) %>%
  tally()

collapsed_taxonomy %>%
  write_csv("csv_outputs/inrange_collapsed_fecal_mifish_taxonomy.csv")
```


```{r}
uncollapsed_taxonomy %>%
  select(species, genus, family, order, taxon, taxonomic_level) %>%
  unique() %>%
  ggplot(aes(x = taxon)) +
  geom_bar(stat = "count") +
  facet_wrap(~family, scales = "free") +
   theme_bw() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.5)
  ) 

```



















#### Read in ASV table ####

```{r}
asv_table <- read.csv("csv_outputs/NFSfecal_MiFish_ASVtable.csv") %>%
  rename(sample = X)

# reformat
sample_df <- asv_table %>%
  pivot_longer(2:length(asv_table), names_to = "ASV", values_to = "reads") %>%
  filter(reads > 0) %>%
  separate(sample, into = c("ablg", "plate", "replicate"), remove = F)

head(sample_df)
```

```{r plate-1}
sample_df %>%
  filter(plate == "plate1") %>%
  filter(reads > 10) %>%
  ggplot(aes(x = ablg, y = reads, fill = ASV)) +
  geom_bar(stat = "identity") +
  facet_grid(rows = vars(replicate)) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90)
  ) +
  labs( 
    title = "NFS fecal samples - plate 1")


```

```{r plate-2}
sample_df %>%
  filter(plate == "plate2") %>%
  filter(reads > 10) %>%
  ggplot(aes(x = ablg, y = reads, fill = ASV)) +
  geom_bar(stat = "identity") +
  facet_grid(rows = vars(replicate)) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90)
  ) +
  labs( 
    title = "NFS fecal samples - plate 2")


```

Just quickly, what are the top species?

```{r combine-data-and-taxonomy}
combined_df <- sample_df %>%
  left_join(., collapsed_taxonomy, by = c("ASV" = "qseqid"))


combined_df %>%
  arrange(desc(reads)) %>%
  filter(!taxon %in% c("Callorhinus ursinus", "Acipenser", "Acipenser fulvescens", "Actinopteri", "uncultured bacterium", "Eumetopias jubatus")) %>%
  group_by(taxon) %>%
  summarise(sum(reads)) %>%
  arrange(desc(`sum(reads)`))


```

```{r}
combined_df %>%
  filter(!taxon %in% c("Callorhinus ursinus", "Acipenser", "Acipenser fulvescens", "Actinopteri", "uncultured bacterium", "Eumetopias jubatus")) %>%
  filter(reads > 10) %>%
  group_by(taxon) %>%
  tally() %>%
  arrange(desc(n))

```

How many sturgeon reads were in the samples? (tag-jumping)
```{r}
combined_df %>%
  filter(taxon == "Acipenser" | taxon == "Acipenser fulvescens") %>%
  filter(!ablg %in% c("PC", "NC") & !replicate %in% c("EB", "FB")) %>%
  arrange(desc(reads)) %>%
  group_by(plate) %>%
  summarise(max(reads))

```

Ok, so as few as 3 reads and as many as 501 in the samples. Not super clean... but we'll proceed for now.
Notably, plates 1 and 3 are very similar, and plate 2 has more apparent cross-contamination/tag-jumping.

```{r}
# what about mean values
combined_df %>%
  filter(taxon == "Acipenser" | taxon == "Acipenser fulvescens") %>%
  filter(!ablg %in% c("PC", "NC") & !replicate %in% c("EB", "FB")) %>%
  arrange(desc(reads)) %>%
  group_by(plate) %>%
  summarise(mean(reads))

```
Interesting! So the mean is actually higher in plate 1.

What's the distribution of read depth across plates though?
```{r}
combined_df %>%
  group_by(plate) %>%
  summarise(mean(reads))

combined_df %>%
  group_by(plate) %>%
  summarise(mean(reads))

#range?
combined_df %>%
  filter(!ablg %in% c("PC", "NC") & !replicate %in% c("EB", "FB")) %>%
  group_by(plate) %>%
  summarise(max(reads))

```
plate 1 has a much higher mean.


## Estimate tag-jumping ##


```{r tag-jumping-by-ASVs-in-PC}
# on a per-plate basis, what % of each ASV should be subtracted from the samples?
asv_prop_df <- combined_df %>%
  filter(!is.na(taxon)) %>%
  group_by(sample) %>%
  mutate(total_reads = sum(reads)) %>%
  mutate(asv_prop = reads/total_reads)
  
asv_prop_df %>%
  filter(ablg == "PC") %>%
  ggplot(aes(x = sample, y = asv_prop, fill = taxon)) +
  geom_bar(stat = "identity") +
  facet_grid(row = vars(replicate)) +
  theme_minimal()

```



```{r which-asv-proportions-to-remove}
# based on asvs in the PC
asv_prop_to_remove <- asv_prop_df %>%
  filter(ablg == "PC") %>%
  ungroup() %>%
  select(plate, ASV, taxon, taxonomic_level, asv_prop) %>%
  rename(prop_to_subtract = asv_prop)

```


```{r remove-asvs-props-from-PC-in-samples}
filtered_sample_df <- asv_prop_df %>%
  left_join(., asv_prop_to_remove) %>%
  mutate(new_asv_prop = ifelse(!is.na(prop_to_subtract), asv_prop-prop_to_subtract, asv_prop)) %>%
  mutate(new_asv_prop = ifelse(new_asv_prop < 0, 0, new_asv_prop)) %>% # remove negative numbers
  filter(new_asv_prop > 0) %>% # remove entries for taxa that we filtered out (human, dog, bacteria, etc.)
  group_by(sample, taxon) %>%
  mutate(taxon_prop = sum(new_asv_prop)) %>%
  select(-new_asv_prop) %>% 
  mutate(taxon_reads = sum(reads)) %>%
  select(-reads, -asv_prop, -prop_to_subtract, -ASV, -total_reads, -taxon_prop) %>%
  filter(taxon != "Acipenser fulvescens") %>% # for some reason this ASV for the PC showed up in one sample.
  # if there are multiple ASVs for a given species, combine those here
  unique() %>% # remove duplicate entries for taxa with multiple ASVs
  # and then recalculate proportions based on the new filtered data for each sample
  ungroup() %>%
  group_by(sample) %>%
  mutate(sample_reads = sum(taxon_reads)) %>%
  mutate(new_tax_prop = taxon_reads/sample_reads)
  

filtered_sample_df
```



```{r consistency-across-extractions-from-the-same-sample?}
# how many samples fell below the 1000 read threshold?
filtered_sample_df %>%
  filter(!ablg %in% c("PC", "NC") & !replicate %in% c("EB", "FB")) %>%
  #filter(plate == "plate3") %>%
  ggplot(aes(x = ablg, y = new_tax_prop, fill = taxon)) +
  geom_bar(stat = "identity") +
  facet_grid(row = vars(plate), cols = vars(replicate)) +
  theme_bw() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90)
  ) +
  labs(y = "proportion of reads")
  
ggsave("pdf_outputs/fecal_mifish_filtered_plate_replicates.pdf", width = 10, height = 5)
```



```{r outputs}
# list of species
taxon_list <- filtered_sample_df %>% 
  filter(!ablg %in% c("PC", "NC") & !replicate %in% c("EB", "FB")) %>%
  group_by(taxon) %>%
  summarise(sum(new_tax_prop)) %>%
  arrange(desc(`sum(new_tax_prop)`))
  
taxon_list %>%  
  write.csv("csv_outputs/fecal_mifish_taxon_list_filtered.csv")

# and dataframe
filtered_sample_df %>%
  write.csv("csv_outputs/fecal_mifish_filtered_df.csv")

```
Questionable species:
Sardinops? looks like distribution *may* include the aleutians?



```{r pull-in-metadata}
metadata <- readxl::read_xlsx("../data/NFS_metadata_20241001.xlsx")

data_w_meta <- filtered_sample_df %>%
  left_join(., metadata, by = c("ablg" = "extraction_ID")) %>%
  select(alternative_ID, source, collection_year, collection_month, collection_day, location1, ablg, everything()) %>%
  rename(taxon_proportion_reads = new_tax_prop)


data_w_meta %>%
  write.csv("csv_outputs/NFS_Bogo_fecal_MiFish_data_w_metadata.csv")

```





